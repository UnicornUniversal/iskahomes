# Lead Message Data Structure

## Overview
When a user clicks on a message/chat button, a `lead_message` action is created. This document explains what data goes into this action.

---

## ğŸ“¤ Event Sent to PostHog

When `analytics.trackMessageClick()` is called, it sends a **unified `lead` event** with `lead_type: 'message'`:

```javascript
{
  event: 'lead',
  properties: {
    lead_type: 'message',
    context_type: 'listing' | 'profile',
    listing_id: 'uuid',
    profile_id: 'uuid', // If context_type is 'profile'
    lister_id: 'uuid',
    lister_type: 'developer' | 'agent' | 'agency',
    message_type: 'direct_message' | 'whatsapp' | 'email',
    seeker_id: 'uuid', // If user is logged in
    is_logged_in: true | false,
    timestamp: '2025-01-15T10:30:00Z'
  }
}
```

---

## ğŸ”„ Processing in Cron Job

When the cron job processes this event, it creates a `lead_message` action object:

```javascript
{
  action_id: 'uuid', // Generated by cron
  action_type: 'lead_message',
  action_date: '20250115', // YYYYMMDD format
  action_hour: 10, // Hour of day (0-23)
  action_timestamp: '2025-01-15T10:30:00Z', // Full ISO timestamp
  action_metadata: {
    context_type: 'listing' | 'profile',
    message_type: 'direct_message' | 'whatsapp' | 'email'
  }
}
```

---

## ğŸ“‹ Message Types

The `message_type` field determines the type of message interaction:

### 1. **`direct_message`** (Default)
- **When**: User clicks "Message" button â†’ opens in-app messaging
- **Points**: 20 points
- **Example Usage**:
  ```javascript
  analytics.trackMessageClick({
    contextType: 'listing',
    listingId: listing.id,
    messageType: 'direct_message' // Default if not specified
  })
  ```

### 2. **`whatsapp`**
- **When**: User clicks WhatsApp button â†’ opens WhatsApp chat
- **Points**: 15 points
- **Example Usage**:
  ```javascript
  analytics.trackMessageClick({
    contextType: 'listing',
    listingId: listing.id,
    messageType: 'whatsapp'
  })
  ```

### 3. **`email`**
- **When**: User clicks email button â†’ copies email to clipboard
- **Points**: 10 points
- **Example Usage**:
  ```javascript
  analytics.trackMessageClick({
    contextType: 'listing',
    listingId: listing.id,
    messageType: 'email'
  })
  ```

---

## ğŸ—‚ï¸ Complete Action Structure in Database

When stored in the `leads` table's `lead_actions` JSONB array:

```json
{
  "action_id": "550e8400-e29b-41d4-a716-446655440000",
  "action_type": "lead_message",
  "action_date": "20250115",
  "action_hour": 10,
  "action_timestamp": "2025-01-15T10:30:00.000Z",
  "action_metadata": {
    "context_type": "listing",
    "message_type": "whatsapp"
  }
}
```

---

## ğŸ“Š How It's Used

### **1. Lead Score Calculation**
The `message_type` determines the points:
- `email` â†’ 10 points
- `whatsapp` â†’ 15 points
- `direct_message` (or default) â†’ 20 points

### **2. Listing Analytics Breakdown**
In `listing_analytics` table:
- `message_type: 'email'` â†’ increments `email_leads`
- `message_type: 'whatsapp'` â†’ increments `message_leads` + `lead_types.whatsapp`
- `message_type: 'direct_message'` â†’ increments `message_leads` + `lead_types.direct_message`

### **3. Lead Actions Display**
In the UI, the action shows:
- Action type: "message" (from `action_type.replace('lead_', '')`)
- Message type: "whatsapp" (from `action_metadata.message_type`)

---

## ğŸ” Where It's Tracked

### **Frontend Components:**

1. **Property Page** (`src/app/property/[listing_type]/[slug]/[id]/page.jsx`):
   - Email click: `messageType: 'email'`
   - Direct message: `messageType: 'direct_message'`

2. **Listing Cards** (`src/app/components/analytics/EnhancedListingCard.jsx`):
   - Message button: `messageType: 'direct_message'`
   - WhatsApp button: `messageType: 'whatsapp'`

3. **Contact Forms**:
   - Any message submission: `messageType: 'direct_message'`

---

## ğŸ“ Example Scenarios

### **Scenario 1: User clicks WhatsApp button**
```javascript
// Frontend
analytics.trackMessageClick({
  contextType: 'listing',
  listingId: 'listing-123',
  messageType: 'whatsapp'
})

// PostHog Event
{
  event: 'lead',
  properties: {
    lead_type: 'message',
    message_type: 'whatsapp',
    listing_id: 'listing-123',
    // ... other properties
  }
}

// Cron Job Creates
{
  action_type: 'lead_message',
  action_metadata: {
    message_type: 'whatsapp',
    context_type: 'listing'
  }
}

// Lead Score: +15 points
```

### **Scenario 2: User clicks Email button**
```javascript
// Frontend
analytics.trackMessageClick({
  contextType: 'listing',
  listingId: 'listing-123',
  messageType: 'email'
})

// Cron Job Creates
{
  action_type: 'lead_message',
  action_metadata: {
    message_type: 'email',
    context_type: 'listing'
  }
}

// Lead Score: +10 points
```

### **Scenario 3: User clicks Message button (default)**
```javascript
// Frontend
analytics.trackMessageClick({
  contextType: 'listing',
  listingId: 'listing-123'
  // messageType not specified â†’ defaults to 'direct_message'
})

// Cron Job Creates
{
  action_type: 'lead_message',
  action_metadata: {
    message_type: 'direct_message', // Default
    context_type: 'listing'
  }
}

// Lead Score: +20 points
```

---

## ğŸ¯ Summary

**What goes into `lead_message`:**

1. **Action Type**: Always `'lead_message'`
2. **Action Metadata**:
   - `context_type`: `'listing'` or `'profile'` (where the action occurred)
   - `message_type`: `'direct_message'`, `'whatsapp'`, or `'email'` (type of message)
3. **Timestamps**:
   - `action_date`: Date in YYYYMMDD format
   - `action_hour`: Hour of day (0-23)
   - `action_timestamp`: Full ISO timestamp
4. **Generated Fields**:
   - `action_id`: Unique UUID generated by cron job

**Key Points:**
- The `message_type` determines the lead score (10, 15, or 20 points)
- Default `message_type` is `'direct_message'` if not specified
- All message types are stored as `lead_message` actions, differentiated by `message_type` in metadata

